!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("maptalks"),require("three")):"function"==typeof define&&define.amd?define(["exports","maptalks","three"],e):e(t.maptalks=t.maptalks||{},t.maptalks,t.THREE)}(this,function(t,R,F){"use strict";function n(t,e){t.prototype=Object.create(e.prototype),(t.prototype.constructor=t).__proto__=e}var i=function(t){function e(){return t.apply(this,arguments)||this}return n(e,t),e.prototype.addTo=function(t){if(t instanceof u)return t.on("mousemove",this.onMouseMove,this),t.on("mouseout",this.onMouseOut,this),this._owner=t,this._switchEvents("on"),this.onAdd&&this.onAdd(),this.fire("add"),this;throw new Error("Invalid BaseObject the tooltip is added to.")},e}(R.ui.ToolTip),o={interactive:!0,altitude:0,minZoom:0,maxZoom:30},u=function(r){function t(t){var e;return(e=r.call(this)||this).isBaseObject=!0,e.isAdd=!1,e.object3d=null,e.options={},e.toolTip=null,e.infoWindow=null,e._mouseover=!1,e._showPlayer=null,void 0===t&&(t=R.Util.GUID()),e.id=t,e}n(t,r);var e=t.prototype;return e.addTo=function(t){return t instanceof At?t.addMesh(this):console.error("layer only support maptalks.ThreeLayer"),this},e.remove=function(){var t=this.getLayer();return t&&t.removeMesh(this),this},e.getObject3d=function(){return this.object3d},e.getId=function(){return this.id},e.setId=function(t){var e=this.getId();return this.id=t,this._fire("idchange",{old:e,new:t,target:this}),this},e.getType=function(){return this.constructor.name},e.getOptions=function(){return this.options},e.getProperties=function(){return(this.options||{}).properties},e.setProperties=function(t){var e=Object.assign({},this.getProperties());return this.options.properties=t,this._fire("propertieschange",{old:e,new:t,target:this}),this},e.getLayer=function(){return this.options.layer},e.getMap=function(){var t=this.getLayer();if(t)return t.getMap()},e.getCenter=function(){var t=this.getOptions(),e=t.coordinate,r=t.lineString,n=t.polygon;if(e)return e;var i=n||r;return i&&i.getCenter?i.getCenter():void 0},e.getAltitude=function(){return this.getOptions().altitude},e.setAltitude=function(t){if(R.Util.isNumber(t)){var e=this.getLayer().distanceToVector3(t,t).x;this.getObject3d().position.z=e,this.options.altitude=t}return this},e.show=function(){return this.getObject3d().visible=!0,this._fire("show"),this},e.hide=function(){return this.getObject3d().visible=!1,this._fire("hide"),this},e.isVisible=function(){return!!this.getObject3d().visible},e.getSymbol=function(){return this.getObject3d().material},e.setSymbol=function(t){if(t&&t instanceof F.Material){t.needsUpdate=!0,t.vertexColors=this.getObject3d().material.vertexColors;var e=this.getObject3d().material.clone();this.getObject3d().material=t,this._fire("symbolchange",{old:e,new:t,target:this})}return this},e.setInfoWindow=function(t){return this.infoWindow=new R.ui.InfoWindow(t),this},e.getInfoWindow=function(){return this.infoWindow},e.openInfoWindow=function(t){return t&&this.infoWindow&&this.infoWindow.show(t),this},e.closeInfoWindow=function(){return this.infoWindow&&this.infoWindow.hide(),this},e.removeInfoWindow=function(){return this.infoWindow&&this.infoWindow.remove()&&delete this.infoWindow,this},e.setToolTip=function(t,e){return this.toolTip=new i(t,e),this},e.getToolTip=function(){return this.toolTip},e.openToolTip=function(t){return t&&this.toolTip&&this.toolTip.show(t),this},e.closeToolTip=function(){return this.toolTip&&this.toolTip.hide(),this},e.removeToolTip=function(){return this.toolTip&&this.toolTip.remove()&&delete this.toolTip,this},e.animateShow=function(t,r){var n=this;void 0===t&&(t={}),this._showPlayer&&this._showPlayer.cancel(),R.Util.isFunction(t)&&(r=t={});var e=t.duration||1e3,i=t.easing||"out",o=this._showPlayer=R.animation.Animation.animate({scale:1},{duration:e,easing:i},function(t){var e=t.styles.scale;0<e&&n.getObject3d().scale.set(1,1,e),r&&r(t,e)});return o.play(),o},e.getMinZoom=function(){return this.getOptions().minZoom},e.getMaxZoom=function(){return this.getOptions().maxZoom},e.config=function(){return this},e._initOptions=function(t){return this.options=R.Util.extend({},o,t),this},e._createMesh=function(t,e){return this.object3d=new F.Mesh(t,e),this.object3d.__parent=this},e._createGroup=function(){return this.object3d=new F.Group,this.object3d.__parent=this},e._createLine=function(t,e){return this.object3d=new F.Line(t,e),this.object3d.computeLineDistances(),this.object3d.__parent=this},e._createPoints=function(t,e){return this.object3d=new F.Points(t,e),this.object3d.__parent=this},e._createLineSegments=function(t,e){return this.object3d=new F.LineSegments(t,e),this.object3d.computeLineDistances(),this.object3d.__parent=this},t}(R.Eventable(function(){})),y={},x="-";function k(t,e){void 0===e&&(e=!0);var r,n=t.height,i=t.radialSegments,o=t.radius,a=t._radius,s=t._height;if(!e){var h=new F.CylinderBufferGeometry(o,o,n,i,1);h.rotateX(Math.PI/2);for(var c=h.attributes.position.array,u=0,l=c.length;u<l;u+=3)c[u+2]+=n/2;return h}for(var d=0;d<=4;d++){var f=[s+d,a,i].join(x).toString();if(r=y[f])break;if(f=[s-d,a,i].join(x).toString(),r=y[f])break}if(r)return r;var v=[s,a,i].join(x).toString();(r=y[v]=new F.CylinderBufferGeometry(o,o,n,i,1)).rotateX(Math.PI/2);for(var p=r.attributes.position.array,g=0,m=p.length;g<m;g+=3)p[g+2]+=n/2;return r}function W(t,e,r,n,i){void 0===n&&(n="y"),void 0===i&&(i=0);var o=0;"y"===n?o=1:"z"===n&&(o=2);for(var a=t.attributes.position.array,s=a.length,h=e instanceof F.Color?e:new F.Color(e),c=new F.Color(r),u=[],l=0;l<s;l+=3){i<a[l+o]?u.push(c.r,c.r,c.b):u.push(h.r,h.r,h.b)}return t.addAttribute("color",new F.Float32BufferAttribute(u,3,!0)),u}var p={radius:10,height:100,radialSegments:6,altitude:0,topColor:null,bottomColor:"#2d2f61"},q=function(v){function t(t,e,r,n){var i;e=R.Util.extend({},p,e,{layer:n,coordinate:t}),(i=v.call(this)||this)._initOptions(e);var o=e,a=o.height,s=o.radius,h=o.topColor,c=o.bottomColor,u=o.altitude;e.height=n.distanceToVector3(a,a).x,e.radius=n.distanceToVector3(s,s).x,e._radius=i.options.radius,e._height=i.options.height,i._h=e.height;var l=k(e);h&&!r.map&&(W(l,c,h,"z",e.height/2),r.vertexColors=F.VertexColors),i._createMesh(l,r);var d=n.distanceToVector3(u,u).x,f=n.coordinateToVector3(t,d);return i.getObject3d().position.copy(f),i}return n(t,v),t}(u);function l(t,e,r){var n=e[0],i=e[1],o=r[0]-n,a=r[1]-i;if(0!==o||0!==a){var s=((t[0]-n)*o+(t[1]-i)*a)/(o*o+a*a);1<s?(n=r[0],i=r[1]):0<s&&(n+=o*s,i+=a*s)}return(o=t[0]-n)*o+(a=t[1]-i)*a}function a(t,e){var r=t.length-1,n=[t[0]];return function t(e,r,n,i,o){for(var a,s=i,h=r+1;h<n;h++){var c=l(e[h],e[r],e[n]);s<c&&(a=h,s=c)}i<s&&(1<a-r&&t(e,r,a,i,o),o.push(e[a]),1<n-a&&t(e,a,n,i,o))}(t,0,r,e,n),n.push(t[r]),n}function d(t,e,r){if(t.length<=2)return t;var n=void 0!==e?e*e:1;return t=a(t=r?t:function(t,e){for(var r,n,i,o,a,s=t[0],h=[s],c=1,u=t.length;c<u;c++)r=t[c],i=s,o=(n=r)[0]-i[0],a=n[1]-i[1],e<o*o+a*a&&(h.push(r),s=r);return s!==r&&h.push(r),h}(t,n),n)}function I(t,e){var r=e[0],n=e[1],i=Math.sqrt(r*r+n*n);return t[0]=r/i,t[1]=n/i,t}function m(t,e,r,n){return t[0]=e[0]+r[0]*n,t[1]=e[1]+r[1]*n,t[2]=e[2]+r[2]*n,t}function G(t,e,r){return t[0]=e[0]-r[0],t[1]=e[1]-r[1],t[2]=e[2]-r[2],t}var b=[];function ut(t,e,r,n){var i,o,a,s,h,c,u,l,d,f,v,p=(o=r,(i=e)[0]*o[0]+i[1]*o[1]+i[2]*o[2]),g=Math.acos(p)*n;return m(b,r,e,-p),h=(s=a=b)[0],c=s[1],u=s[2],l=Math.sqrt(h*h+c*c+u*u),a[0]=h/l,a[1]=c/l,a[2]=u/l,d=t,f=e,v=Math.cos(g),d[0]=f[0]*v,d[1]=f[1]*v,d[2]=f[2]*v,m(t,t,b,Math.sin(g)),t}var z=[],U=[],E=[];function A(t,e,r,n,i,o,a,s){var h,c,u,l,d,f=null!=a,v=i,p=null;f&&(p=new Uint32Array(n-r));for(var g=r;g<n;g++){var m=g===n-1?r:g+1,y=g===r?n-1:g-1,x=t[2*y],b=t[2*y+1],_=t[2*g],w=t[2*g+1],M=t[2*m],C=t[2*m+1];if(z[0]=_-x,z[1]=w-b,U[0]=M-_,U[1]=C-w,I(z,z),I(U,U),f&&(p[g]=v),s||g!==r)if(s||g!==n-1){l=U,d=z,(u=E)[0]=l[0]+d[0],u[1]=l[1]+d[1];var O=E[1];E[1]=-E[0],E[0]=O,I(E,E);var j=(c=U,(h=E)[0]*c[0]+h[1]*c[1]),A=Math.sqrt(1-j*j),T=o*Math.min(10,1/A);if(f&&a<1/A&&o*j<0){var S=_+E[0]*o,V=w+E[1]*o,B=Math.acos(A)/2,G=Math.tan(B)*Math.abs(o);e[2*v]=S+E[1]*G,e[2*v+1]=V-E[0]*G,e[2*++v]=S-E[1]*G,e[2*v+1]=V+E[0]*G,v++}else e[2*v]=_+E[0]*T,e[2*v+1]=w+E[1]*T,v++}else E[0]=z[1],E[1]=-z[0],I(E,E),e[2*v]=_+E[0]*o,e[2*v+1]=w+E[1]*o,v++;else E[0]=U[1],E[1]=-U[0],I(E,E),e[2*v]=_+E[0]*o,e[2*v+1]=w+E[1]*o,v++}return p}function T(t,e,r,n){for(var i=0;i<Math.floor((n-r)/2);i++)for(var o=0;o<e;o++){var a=(i+r)*e+o,s=(n-i-1)*e+o,h=t[a];t[a]=t[s],t[s]=h}return t}var lt=[[0,0],[1,0],[1,1],[0,0],[1,1],[0,1]];function S(t,e,r,n,i,o){var a=e.vertices,s=e.topVertices,h=e.depth,c=e.rect,u=n-r,l=o.smoothSide?1:2,d=u*l,f=o.smoothBevel?1:2,v=Math.min(h/2,o.bevelSize),p=o.bevelSegments,g=i.vertex,m=Math.max(c.width,c.height);if(0<v)for(var y=[0,0,1],x=[],b=[0,0,-1],_=[],w=0,M=new Float32Array(u),C=0;C<2;C++)for(var O=0===C?h-v:v,j=0;j<=p*f;j++){for(var A=0,T=void 0,S=void 0,V=0;V<u;V++){for(var B=0;B<l;B++){var G=2*((V+B)%u+r);x[0]=a[G]-s[G],x[1]=a[G+1]-s[G+1],x[2]=0;var I=Math.sqrt(x[0]*x[0]+x[1]*x[1]);x[0]/=I,x[1]/=I;var z=(Math.floor(j/f)+j%f)/p;0===C?ut(_,y,x,z):ut(_,x,b,z);var U=0===C?z:1-z,E=v*Math.sin(U*Math.PI/2),P=I*Math.cos(U*Math.PI/2),L=v*I/Math.sqrt(E*E+P*P),R=_[0]*L+s[G],F=_[1]*L+s[G+1],k=_[2]*L+O;if(t.position[3*i.vertex]=R,t.position[3*i.vertex+1]=F,t.position[3*i.vertex+2]=k,(0<V||0<B)&&(A+=Math.sqrt((T-R)*(T-R)+(S-F)*(S-F))),0<j||0<C){var W=3*(i.vertex-d),q=t.position[W],H=t.position[W+1],D=t.position[W+2];M[V]+=Math.sqrt((q-R)*(q-R)+(H-F)*(H-F)+(D-k)*(D-k))}t.uv[2*i.vertex]=A/m,t.uv[2*i.vertex+1]=M[V]/m,T=R,S=F,i.vertex++}if(1<f&&j%f||1===f&&1<=j)for(var Z=0;Z<6;Z++){var N=(lt[Z][0]+V*l)%d,X=lt[Z][1]+w;t.indices[i.index++]=(X-1)*d+N+g}}w++}else for(var J=0;J<2;J++)for(var K=0===J?h-v:v,Q=0,Y=void 0,$=void 0,tt=0;tt<u;tt++)for(var et=0;et<l;et++){var rt=2*((tt+et)%u+r),nt=a[rt],it=a[rt+1];t.position[3*i.vertex]=nt,t.position[3*i.vertex+1]=it,t.position[3*i.vertex+2]=K,(0<tt||0<et)&&(Q+=Math.sqrt((Y-nt)*(Y-nt)+($-it)*($-it))),t.uv[2*i.vertex]=Q/m,t.uv[2*i.vertex+1]=K/m,Y=nt,$=it,i.vertex++}for(var ot=0<v?p*f+1:1,at=0;at<u;at++)for(var st=0;st<6;st++){var ht=(lt[st][0]+at*l)%d,ct=lt[st][1]+ot;t.indices[i.index++]=(ct-1)*d+ht+g}}function V(t,e,r,n){var i=t.indices,o=t.vertices,a=t.topVertices,s=t.rect,h=t.depth;if(!(o.length<=4)){for(var c=r.vertex,u=i.length,l=0;l<u;l++)e.indices[r.index++]=c+i[l];for(var d=Math.max(s.width,s.height),f=0;f<(n.excludeBottom?1:2);f++)for(var v=0;v<a.length;v+=2){var p=a[v],g=a[v+1];e.position[3*r.vertex]=p,e.position[3*r.vertex+1]=g,e.position[3*r.vertex+2]=(1-f)*h,e.uv[2*r.vertex]=(p-s.x)/d,e.uv[2*r.vertex+1]=(g-s.y)/d,r.vertex++}if(!n.excludeBottom)for(var m=o.length/2,y=0;y<u;y+=3)for(var x=0;x<3;x++)e.indices[r.index++]=c+m+i[y+2-x]}}function f(t,e){for(var r=0,n=0,i=0;i<t.length;i++){var o=t[i],a=o.indices,s=o.vertices,h=o.holes,c=o.depth,u=s.length/2,l=0<Math.min(c/2,e.bevelSize)?e.bevelSegments:0;r+=a.length*(e.excludeBottom?1:2),n+=u*(e.excludeBottom?1:2);for(var d=2+2*l,f=0,v=0,p=0;p<(h?h.length:0)+1;p++){r+=6*((v=0===p?h&&h.length?h[0]:u:(f=h[p-1],h[p]||u))-f)*(d-1);var g=(v-f)*(e.smoothSide?1:2);n+=g*d+(e.smoothBevel?0:l*g*2)}}for(var m={position:new Float32Array(3*n),indices:new(65535<n?Uint32Array:Uint16Array)(r),uv:new Float32Array(2*n)},y={vertex:0,index:0},x=0;x<t.length;x++)V(t[x],m,y,e);for(var b=0;b<t.length;b++){var _=t[b],w=(h=_.holes,(s=_.vertices).length/2),M=0,C=h&&h.length?h[0]:w;if(S(m,t[b],M,C,y,e),h)for(var O=0;O<h.length;O++)M=h[O],C=h[O+1]||w,S(m,t[b],M,C,y,e)}for(var j=0;j<m.uv.length;j++){var A=m.uv[j];0<A&&Math.round(A)===A?m.uv[j]=1:m.uv[j]=A%1}return m.normal=function(t,e){function r(t,e,r,n){t[0]=e,t[1]=r,t[2]=n}for(var n,i,o,a,s,h,c,u,l,d,f,v,p,g,m,y=[],x=[],b=[],_=[],w=[],M=[],C=t.length,O=new Float32Array(e.length),j=0;j<C;){var A=3*t[j++],T=3*t[j++],S=3*t[j++];r(y,e[A],e[A+1],e[A+2]),r(x,e[T],e[T+1],e[T+2]),r(b,e[S],e[S+1],e[S+2]),G(_,y,x),G(w,x,b),n=M,o=w,a=(i=_)[0],s=i[1],h=i[2],c=o[0],u=o[1],l=o[2],n[0]=s*l-h*u,n[1]=h*c-a*l,n[2]=a*u-s*c;for(var V=0;V<3;V++)O[A+V]=O[A+V]+M[V],O[T+V]=O[T+V]+M[V],O[S+V]=O[S+V]+M[V]}for(var B=0;B<O.length;)r(M,O[B],O[B+1],O[B+2]),v=(f=d=M)[0],p=f[1],g=f[2],m=Math.sqrt(v*v+p*p+g*g),d[0]=v/m,d[1]=p/m,d[2]=g/m,O[B++]=M[0],O[B++]=M[1],O[B++]=M[2];return O}(m.indices,m.position),m.boundingRect=t[0]&&t[0].rect,m}function v(t,e,r){for(var n=r.lineWidth,i=t.length,o=new Float32Array(2*i),a=r.translate||[0,0],s=r.scale||[1,1],h=0,c=0;h<i;h++)o[c++]=t[h][0]*s[0]+a[0],o[c++]=t[h][1]*s[1]+a[1];(function(t,e,r){if(r-e<3)return 0;for(var n=0,i=2*(r-1),o=2*e;o<2*r;){var a=t[i],s=t[i+1],h=t[o],c=t[o+1];i=o,o+=2,n+=a*c-h*s}return n})(o,0,i)<0&&T(o,2,0,i);var u=[],l=[],d=r.miterLimit,f=A(o,l,0,i,0,-n/2,d,!1);T(o,2,0,i);for(var v=A(o,u,0,i,0,-n/2,d,!1),p=(u.length+l.length)/2,g=new Float32Array(2*p),m=0,y=l.length/2,x=0;x<l.length;x++)g[m++]=l[x];for(var b=0;b<u.length;b++)g[m++]=u[b];for(var _=new(65535<p?Uint32Array:Uint16Array)(3*(2*(i-1)+(p-2*i))),w=0,M=0;M<i-1;M++){var C=M+1;_[w++]=y-1-f[M],_[w++]=y-1-f[M]-1,_[w++]=v[M]+1+y,_[w++]=y-1-f[M],_[w++]=v[M]+1+y,_[w++]=v[M]+y,v[C]-v[M]==2?(_[w++]=v[M]+2+y,_[w++]=v[M]+1+y,_[w++]=y-f[C]-1):f[C]-f[M]==2&&(_[w++]=v[C]+y,_[w++]=y-1-(f[M]+1),_[w++]=y-1-(f[M]+2))}var O=0<r.bevelSize?function(t,e,r,n,i){var o=null!=n?[]:new Float32Array(t.length);if(A(t,o,0,e&&e.length?e[0]:t.length/2,0,r,n,i),e)for(var a=0;a<e.length;a++){var s=e[a];A(t,o,s,e[a+1]||t.length/2,null!=n?o.length/2:s,r,n,i)}return o}(g,[],r.bevelSize,null,!0):g,j=r.boundingRect;return{vertices:g,indices:_,topVertices:O,rect:{x:j.x*s[0]+a[0],y:j.y*s[1]+a[1],width:j.width*s[0],height:j.height*s[1]},depth:"function"==typeof r.depth?r.depth(e):r.depth,holes:[]}}function g(t,e){e=Object.assign({},e);for(var r=[1/0,1/0],n=[-1/0,-1/0],i=0;i<t.length;i++)_(t[i],r,n);e.boundingRect=e.boundingRect||{x:r[0],y:r[1],width:n[0]-r[0],height:n[1]-r[1]},function(t){t.depth=t.depth||1,t.bevelSize=t.bevelSize||0,t.bevelSegments=null==t.bevelSegments?2:t.bevelSegments,t.smoothSide=t.smoothSide||!1,t.smoothBevel=t.smoothBevel||!1,t.simplify=t.simplify||0,"number"==typeof t.depth&&(t.bevelSize=Math.min(0<t.bevelSegments?t.bevelSize:0,t.depth/2)),0<t.bevelSize||(t.bevelSegments=0),t.bevelSegments=Math.round(t.bevelSegments);var e=t.boundingRect;if(t.translate=t.translate||[0,0],t.scale=t.scale||[1,1],t.fitRect){var r=null==t.fitRect.x?e.x||0:t.fitRect.x,n=null==t.fitRect.y?e.y||0:t.fitRect.y,i=t.fitRect.width,o=t.fitRect.height;null==i?null!=o?i=o/e.height*e.width:(i=e.width,o=e.height):null==o&&(o=i/e.width*e.height),t.scale=[i/e.width,o/e.height],t.translate=[(r-e.x)*t.scale[0],(n-e.y)*t.scale[1]]}}(e);var o=e.scale||[1,1];null==e.lineWidth&&(e.lineWidth=1),null==e.miterLimit&&(e.miterLimit=2);for(var a=[],s=0;s<t.length;s++){var h=t[s],c=e.simplify/Math.max(o[0],o[1]);0<c&&(h=d(h,c,!0)),a.push(v(h,s,e))}return f(a,e)}function _(t,e,r){for(var n=0;n<t.length;n++)e[0]=Math.min(t[n][0],e[0]),e[1]=Math.min(t[n][1],e[1]),r[0]=Math.max(t[n][0],r[0]),r[1]=Math.max(t[n][1],r[1])}var w=",";function B(t,e,r){var n=[],i=[];if(Array.isArray(t)&&t[0]instanceof F.Vector3)for(var o=0,a=t.length;o<a;o++){var s=t[o];n.push(s.x,s.y,s.z),i.push(s)}else{if(Array.isArray(t)&&(t=new R.LineString(t)),!(t&&t instanceof R.LineString))return null;for(var h=t.getCoordinates(),c=e.coordinateToVector3(r||t.getCenter()),u=0,l=h.length;u<l;u++){var d=h[u];Array.isArray(d)&&(d=new R.Coordinate(d));var f=e.coordinateToVector3(d,0).sub(c);n.push(f.x,f.y,f.z),i.push(f)}}return{positions:n,positionsV:i}}function P(t,e,r,n,i){void 0===e&&(e=1),void 0===r&&(r=1);for(var o=B(t,n,i).positionsV,a=[],s=0,h=o.length;s<h;s++){var c=o[s];a.push([c.x,c.y])}var u=g([a],{lineWidth:e,depth:r}),l=u.indices,d=u.position,f=u.normal,v=new F.BufferGeometry;return v.addAttribute("position",new F.Float32BufferAttribute(d,3)),v.addAttribute("normal",new F.Float32BufferAttribute(f,3)),v.setIndex(new F.Uint32BufferAttribute(l,1)),v}function L(t,e,r,n){for(var i=[],o=[],a=[],s=0,h=t.length;s<h;s++)for(var c=t[s],u=0,l=c.length;u<l;u++){var d=c[u];if(0<a.length)d.join(w).toString()!==a[a.length-1].join(w).toString()&&a.push(d);else a.push(d)}for(var f=0,v=a.length;f<v;f++){var p=a[f],g=void 0,m=p.join(w).toString();g=r&&r[m]?r[m]:e.coordinateToVector3(p,0).sub(n),o.push(g),i.push(g.x,g.y,g.z)}return{positions:i,positionsV:o,lnglats:a}}function H(t,e,r,n,i){void 0===e&&(e=1),void 0===r&&(r=1);for(var o=B(t,n,i).positionsV,a=[],s=0,h=o.length;s<h;s++){var c=o[s];a.push([c.x,c.y])}var u=g([a],{lineWidth:e,depth:r}),l=u.indices;return{position:u.position,normal:u.normal,indices:l}}var M={altitude:0,colors:null},D=function(v){function t(t,e,r,n){var i;e=R.Util.extend({},M,e,{layer:n,lineString:t}),(i=v.call(this)||this)._initOptions(e);var o=B(t,n).positions,a=new F.BufferGeometry;a.addAttribute("position",new F.Float32BufferAttribute(o,3));var s,h,c=(s=e.colors,h=[],s&&s.length&&s.forEach(function(t){t=t instanceof F.Color?t:new F.Color(t),h.push(t.r,t.g,t.b)}),h);c&&c.length&&(a.addAttribute("color",new F.Float32BufferAttribute(c,3)),r.vertexColors=F.VertexColors),i._createLine(a,r);var u=e.altitude,l=t.getCenter(),d=n.distanceToVector3(u,u).x,f=n.coordinateToVector3(l,d);return i.getObject3d().position.copy(f),i}return n(t,v),t}(u),C={width:3,height:1,altitude:0},Z=function(f){function t(t,e,r,n){var i;e=R.Util.extend({},C,e,{layer:n,lineString:t}),(i=f.call(this)||this)._initOptions(e);var o=e,a=o.height,s=o.width;e.height=n.distanceToVector3(a,a).x,e.width=n.distanceToVector3(s,s).x;var h=P(t,e.width,e.height,n);i._createMesh(h,r);var c=e.altitude,u=t.getCenter(),l=n.distanceToVector3(c,c).x,d=n.coordinateToVector3(u,l);return i.getObject3d().position.copy(d),i}return n(t,f),t}(u);function h(t,r,e){var n,i;i=Array.isArray(t)?(n=t[0],t.slice(1,t.length)):(n=t.getShell(),t.getHoles()),e=e||t.getCenter();var o=r.coordinateToVector3(e),a=n.map(function(t){return r.coordinateToVector3(t).sub(o)}),s=new F.Shape(a);return i&&0<i.length&&(s.holes=i.map(function(t){var e=t.map(function(t){return r.coordinateToVector3(t).sub(o)});return new F.Shape(e)})),s}function N(e,t,r,n){if(!e)return null;var i;if(e instanceof R.MultiPolygon?i=e.getGeometries().map(function(t){return h(t,r,n||e.getCenter())}):e instanceof R.Polygon&&(i=h(e,r,n||e.getCenter())),!i)return null;t=r.distanceToVector3(t,t).x;var o={bevelEnabled:!1,bevelSize:1};o[93<=parseInt(F.REVISION)?"depth":"amount"]=t;var a=new F.ExtrudeGeometry(i,o),s=new F.BufferGeometry;return s.fromGeometry(a),s}function X(t,e,r){for(var n=t.attributes.position.array,i=n.length,o=e instanceof F.Color?e:new F.Color(e),a=new F.Color(r),s=[],h=0;h<i;h+=3){0<n[h+2]?s.push(a.r,a.r,a.b):s.push(o.r,o.r,o.b)}return t.addAttribute("color",new F.Float32BufferAttribute(s,3,!0)),s}function J(t){void 0===t&&(t=[]);for(var e=1/0,r=1/0,n=-1/0,i=-1/0,o=0,a=t.length;o<a;o++){var s=t[o],h=void 0,c=void 0;Array.isArray(s)?(h=s[0],c=s[1]):s instanceof R.Coordinate&&(h=s.x,c=s.y),e=Math.min(e,h),r=Math.min(r,c),n=Math.max(n,h),i=Math.max(i,c)}return new R.Coordinate((e+n)/2,(r+i)/2)}var O={altitude:0,height:1,topColor:null,bottomColor:"#2d2f61"},K=function(v){function t(t,e,r,n){var i;e=R.Util.extend({},O,e,{layer:n,polygon:t}),(i=v.call(this)||this)._initOptions(e);var o=e,a=o.height,s=o.topColor,h=o.bottomColor,c=o.altitude,u=N(t,a,n);s&&!r.map&&(X(u,h,s),r.vertexColors=F.VertexColors),i._createMesh(u,r);var l=t.getCenter(),d=n.distanceToVector3(c,c).x,f=n.coordinateToVector3(l,d);return i.getObject3d().position.copy(f),i}return n(t,v),t}(u),j={altitude:0,coordinate:null},s=function(c){function t(t,e,r){var n;void 0===e&&(e={}),e.coordinate||(console.warn("coordinate is null,it is important to locate the model"),e.coordinate=r.getMap().getCenter()),e=R.Util.extend({},j,e,{layer:r,model:t}),(n=c.call(this)||this)._initOptions(e),n._createGroup(),n.getObject3d().add(t);var i=e,o=i.altitude,a=i.coordinate,s=r.distanceToVector3(o,o).x,h=r.coordinateToVector3(a,s);return n.getObject3d().position.copy(h),n}return n(t,c),t}(u),e=Math.PI/180,c=6378137,Q=1;function Y(t){return t*e}function $(t,e){if(!t||!e)return 0;Array.isArray(t)||(t=t.toArray()),Array.isArray(e)||(e=e.toArray());var r=Y(t[1]),n=Y(e[1]),i=r-n,o=Y(t[0])-Y(e[0]);return r=2*Math.asin(Math.sqrt(Math.pow(Math.sin(i/2),2)+Math.cos(r)*Math.cos(n)*Math.pow(Math.sin(o/2),2))),r*=c,Math.round(1e5*r)/1e5}function tt(t,e,r,n){var i=e.length;t.attributes.normal.count=i,t.attributes.position.count=i;for(var o=t.attributes.position.array,a=t.attributes.normal.array,s=0;s<i;s++)o[s]=e[s],a[s]=r[s];t.index.count=n.length;for(var h=0,c=n.length;h<c;h++)t.index.array[h]=n[h]}var et={trail:5,chunkLength:50,width:2,height:1,speed:1,altitude:0,interactive:!1},rt=function(I){function t(t,e,r,n){var i;e=R.Util.extend({},et,e,{layer:n,lineString:t}),(i=I.call(this)||this)._initOptions(e);for(var o=e,a=o.width,s=o.height,h=o.altitude,c=o.speed,u=o.chunkLength,l=o.trail,d=function(t,e){void 0===e&&(e=10),e=Math.max(e,Q),Array.isArray(t)||(t=t.getCoordinates().map(function(t){return t.toArray()}));for(var r=t.length,n=[],i=0,o=0;o<r-1;o++){var a=$(t[o],t[o+1]),s=Math.floor(a);n.push({c1:t[o],len:s,c2:t[o+1]}),i+=s}if(i<=e)return n.map(function(t){return[t.c1,t.c2]});if(1===n.length&&n[0].len<=e)return[[n[0].c1,n[0].c2]];for(var h,c,u,l,d,f,v,p,g,m=n.length,y=0,x=0,b=[],_=[n[0].c1];y<m;){var w=n[y],M=w.len,C=w.c2;if((x+=M)<e&&(_.push(C),y===m-1&&b.push(_),y++),x===e&&(_.push(C),x=0,b.push(_),_=[C],y++),e<x){var O=M-x+e;c=n[y],u=O,l=c.len,d=c.c1,f=c.c2,v=f[0]-d[0],p=f[1]-d[1],g=u/l,h=[d[0]+g*v,d[1]+g*p],_.push(h),b.push(_),x=0,n[y].c1=h,n[y].len=M-O,(_=[]).push(h)}}return b}(t,u),f=n.coordinateToVector3(t.getCenter()),v={},p=0,g=d.length;p<g;p++)for(var m=d[p],y=0,x=m.length;y<x;y++){var b=m[y],_=b.join(",").toString();v[_]||(v[_]=n.coordinateToVector3(b).sub(f))}var w=L(d.slice(0,1),n,v,f).positionsV,M=new F.BufferGeometry,C=new Float32Array(3e3),O=new Float32Array(3e3),j=new Uint16Array(1e3);M.addAttribute("position",new F.BufferAttribute(C,3).setDynamic(!0)),M.addAttribute("normal",new F.BufferAttribute(O,3).setDynamic(!0)),M.setIndex(new F.BufferAttribute(j,1));var A=n.distanceToVector3(a,a).x,T=n.distanceToVector3(s,s).x,S=H(w,A,T,n);tt(M,S.position,S.normal,S.indices),i._createMesh(M,r);var V=n.distanceToVector3(h,h).x,B=t.getCenter(),G=n.coordinateToVector3(B,V);return i.getObject3d().position.copy(G),i._params={index:0,chunkLines:d,geometries:[],layer:n,trail:Math.max(1,l),lineWidth:A,depth:T,speed:Math.min(1,c),idx:0,loaded:!1,positionMap:v,centerPt:f},i._init(i._params),i}n(t,I);var e=t.prototype;return e._init=function(t){for(var e=t.layer,r=t.trail,n=t.lineWidth,i=t.depth,o=t.chunkLines,a=t.positionMap,s=t.centerPt,h=o.length,c=[],u=0;u<h;u++){var l=L(o.slice(u,u+r),e,a,s).positionsV;c.push(H(l,n,i,e))}this._params.geometries=c,this._params.loaded=!0},e._animation=function(){var t=this._params,e=t.index,r=t.geometries,n=t.speed,i=t.idx,o=t.chunkLines,a=t.trail,s=t.lineWidth,h=t.depth,c=t.loaded,u=t.layer,l=t.positionMap,d=t.centerPt;if(c){var f=Math.round(e);if(i<f){this._params.idx++;var v=r[f];if(!v)v=H(L(o.slice(f,f+a),u,l,d).positionsV,s,h,u),r[f]=v;tt(this.getObject3d().geometry,v.position,v.normal,v.indices),this.getObject3d().geometry.attributes.position.needsUpdate=!0,this.getObject3d().geometry.attributes.normal.needsUpdate=!0,this.getObject3d().geometry.index.needsUpdate=!0}e>=o.length-1&&(this._params.index=-1,this._params.idx=-1),this._params.index+=n}},t}(u),nt=["click","mousemove","mousedown","mouseup","dblclick","contextmenu"].join(" ").toString(),r=function(t){return function(t){function e(){return t.apply(this,arguments)||this}n(e,t);var r=e.prototype;return r._initBaseObjectsEvent=function(t){if(t&&Array.isArray(t)&&t.length)for(var e=0,r=t.length;e<r;e++){var n=t[e];this._proxyEvent(n)}return this},r._proxyEvent=function(t){var e=this;t.on("add",function(t){e._showGeometry(t.target,!0)}),t.on("remove",function(t){e._showGeometry(t.target,!1)}),t.on("mouseout",function(t){e._mouseover=!1,e._fire("mouseout",Object.assign({},t,{target:e,selectMesh:e.getSelectMesh?e.getSelectMesh():null}))}),t.on(nt,function(t){e._fire(t.type,Object.assign({},t,{target:e,selectMesh:e.getSelectMesh?e.getSelectMesh():null}))})},r._getHideGeometryIndex=function(t){for(var e=[],r=0,n=0,i=this._geometriesAttributes.length;n<i;n++)!0===this._geometriesAttributes[n].hide&&(e.push(n),r+=this._geometriesAttributes[n][t].count);return{indexs:e,count:r}},r._updateAttribute=function(t,e){for(var r=this._getHideGeometryIndex(e).indexs,n=this._geometryCache.attributes[e].array,i=n.length,o=0;o<i;o++)t.array[o]=n[o];var a=NaN;this.getObject3d()instanceof F.LineSegments&&(a=0);for(var s=0;s<r.length;s++)for(var h=r[s],c=this._geometriesAttributes[h][e],u=c.start,l=c.end,d=u;d<l;d++)t.array[d]=a;return this},r._showGeometry=function(t,e){var r;if(t&&(r=t.getOptions().index),null!=r){var n=this._geometriesAttributes[r];if(n.hide===e)return this;n.hide=e;var i=this.getObject3d().geometry;this._updateAttribute(i.attributes.position,"position"),i.attributes.position.needsUpdate=!0,this.isHide=e}return this},r.getSelectMesh=function(){return{data:null,baseObject:null}},e}(t)},it={altitude:0,height:1,topColor:null,bottomColor:"#2d2f61"},ot=function(U){function t(t,e,r,n){var i;F.BufferGeometryUtils||console.error("not find BufferGeometryUtils,please include related scripts"),Array.isArray(t)||(t=[t]);for(var o=[],a=t.length,s=0;s<a;s++){var h=t[s];o.push(h.getCenter())}for(var c=J(o),u=[],l=[],d=0,f=[],v=[],p=0,g=0,m=0,y=0;y<a;y++){var x=t[y],b=(x.getProperties()||{}).height||1,_=N(x,b,n,c);u.push(_);var w=new K(x,Object.assign({},e,{height:b,index:y}),r,n);l.push(w);var M=new F.Geometry;M.fromBufferGeometry(_);var C=M.faces.length;f[y]=[d+1,d+C],d+=C,M.dispose();var O=_.attributes.position.count,j=_.attributes.normal.count,A=_.attributes.uv.count;v[y]={position:{count:O,start:p,end:p+3*O},normal:{count:j,start:g,end:g+3*j},uv:{count:A,start:m,end:m+2*A},hide:!1},p+=3*O,g+=3*j,m+=2*A}var T=F.BufferGeometryUtils.mergeBufferGeometries(u);e=R.Util.extend({},it,e,{layer:n,polygons:t,coordinate:c}),(i=U.call(this)||this)._initOptions(e);var S=e,V=S.topColor,B=S.bottomColor,G=S.altitude;V&&!r.map&&(X(T,B,V),r.vertexColors=F.VertexColors),i._createMesh(T,r);var I=n.distanceToVector3(G,G).x,z=n.coordinateToVector3(c,I);return i.getObject3d().position.copy(z),i._faceMap=f,i._baseObjects=l,i._datas=t,i._geometriesAttributes=v,i.faceIndex=null,i._geometryCache=T.clone(),i.isHide=!1,i._initBaseObjectsEvent(l),i}n(t,U);var e=t.prototype;return e.getSelectMesh=function(){var t=this._getIndex();if(null!=t)return{data:this._datas[t],baseObject:this._baseObjects[t]}},e._getIndex=function(t){if(null==t&&(t=this.faceIndex),null!=t)for(var e=0,r=this._faceMap.length;e<r;e++){var n=this._faceMap[e],i=n[0],o=n[1];if(i<=t&&t<o)return e}},t}(r(u));function at(t,e,r){var n=t.project(r),i=e.width/2,o=e.height/2;return{x:Math.round(n.x*i+i),y:Math.round(-n.y*o+o)}}var st={altitude:0,height:0},ht=new F.Vector3,ct=function(p){function t(t,e,r,n){var i;e=R.Util.extend({},st,e,{layer:n,coordinate:t}),i=p.call(this)||this;var o=e,a=o.height,s=o.altitude,h=o.color,c=[],u=[];h&&(h=h instanceof F.Color?h:new F.Color(h),u.push(h.r,h.g,h.b));var l=n.distanceToVector3(a,a).x,d=n.coordinateToVector3(t,l);c.push(d.x,d.y,d.z);var f=new F.BufferGeometry;f.addAttribute("position",new F.Float32BufferAttribute(c,3,!0)),u.length&&f.addAttribute("color",new F.Float32BufferAttribute(u,3,!0)),e.positions=d,i._initOptions(e),i._createPoints(f,r);var v=n.distanceToVector3(s,s).x;return i.getObject3d().position.z=v,i}return n(t,p),t.prototype.identify=function(t){var e=this.getLayer(),r=this.getMap().getSize(),n=this.getLayer().getCamera(),i=this.getOptions().positions,o=this.getOptions().altitude,a=this.getObject3d().material.size,s=this.getMap().coordToContainerPoint(t),h=e.distanceToVector3(o,o).x;ht.x=i.x,ht.y=i.y,ht.z=i.z+h;var c=at(ht,r,n);return Math.sqrt(Math.pow(s.x-c.x,2)+Math.pow(s.y-c.y,2))<=a/2},t}(u);function dt(t,e){var r=t.minx,n=t.miny,i=t.maxx,o=t.maxy,a=e[0],s=e[1];return r<=a&&a<=i&&n<=s&&s<=o}var ft=function(){function d(t,e,r,n){this.minlng=t,this.minlat=e,this.maxlng=r,this.maxlat=n,this.minx=1/0,this.miny=1/0,this.maxx=-1/0,this.maxy=-1/0,this.coordinates=[],this.positions=[],this.indexs=[],this.key=null}var t=d.prototype;return t.updateBBoxPixel=function(e){var r=1/0,n=1/0,i=-1/0,o=-1/0,t=this.minlng,a=this.minlat,s=this.maxlng,h=this.maxlat;return[[t,a],[t,h],[s,a],[s,h]].map(function(t){return new R.Coordinate(t)}).map(function(t){return e.coordToContainerPoint(t)}).forEach(function(t){r=Math.min(r,t.x),n=Math.min(n,t.y),i=Math.max(i,t.x),o=Math.max(o,t.y)}),this.minx=r,this.miny=n,this.maxx=i,this.maxy=o,this},t.containsCoordinate=function(t){var e,r;Array.isArray(t)?(e=t[0],r=t[1]):t instanceof R.Coordinate&&(e=t.x,r=t.y);var n=this.minlng,i=this.minlat,o=this.maxlng,a=this.maxlat;return!!(n<=e&&e<=o&&i<=r&r<=a)},t.isRecCross=function(t,e){var r=t.x,n=t.y,i={minx:r-e/2,miny:n-e/2,maxx:r+e/2,maxy:n+e/2},o=i.minx,a=i.miny,s=i.maxx,h=i.maxy;return!!(dt(this,[o,a])||dt(this,[o,h])||dt(this,[s,a])||dt(this,[s,h])||dt(i,[this.minx,this.miny])||dt(i,[this.minx,this.maxy])||dt(i,this.maxx,this.miny)||dt(i,this.maxx,this.maxy))},d.initGrids=function(t,e,r,n){for(var i=[],o=(r-t)/30,a=(n-e)/30,s=t,h=e,c=0;c<30;c++){s=t+c*o;for(var u=0;u<30;u++){var l=new d(s,h=e+u*a,s+o,h+a);l.key=u+"-"+c,i.push(l)}}return i},d}(),vt={altitude:0},pt=new F.Vector3,gt=function(I){function t(t,e,r,n){var i;Array.isArray(t)||(t=[t]),e=R.Util.extend({},vt,e,{layer:n,points:t});for(var o=1/0,a=1/0,s=-1/0,h=-1/0,c=0,u=t.length;c<u;c++){var l=t[c].coordinate,d=void 0,f=void 0;Array.isArray(l)?(d=l[0],f=l[1]):l instanceof R.Coordinate&&(d=l.x,f=l.y),o=Math.min(o,d),a=Math.min(a,f),s=Math.max(s,d),h=Math.max(h,f)}for(var v=ft.initGrids(o,a,s,h),p=v.length,g=[],m=[],y=[],x=[],b=[],_=0,w=t.length;_<w;_++){var M=t[_],C=(l=M.coordinate,M.height),O=M.color;O&&(O=O instanceof F.Color?O:new F.Color(O),y.push(O.r,O.g,O.b));var j=n.distanceToVector3(C,C).x,A=n.coordinateToVector3(l,j);if(g.push(A.x,A.y,A.z),m.push(A),w<=1e5){var T=new ct(l,{height:C,index:_},r,n);x.push(T)}b[_]={position:{count:1,start:3*_,end:3*_+3},hide:!1};for(var S=0;S<p;S++)if(v[S].containsCoordinate(l)){v[S].positions.push(A),v[S].indexs.push(_);break}}var V=new F.BufferGeometry;V.addAttribute("position",new F.Float32BufferAttribute(g,3,!0)),y.length&&V.addAttribute("color",new F.Float32BufferAttribute(y,3,!0)),e.positions=m,(i=I.call(this)||this)._initOptions(e),i._createPoints(V,r);var B=e.altitude,G=n.distanceToVector3(B,B).x;return i.getObject3d().position.z=G,i._baseObjects=x,i._data=t,i.faceIndex=null,i._geometriesAttributes=b,i._geometryCache=V.clone(),i.isHide=!1,i._initBaseObjectsEvent(x),i._grids=v,i._bindMapEvents(),i}n(t,I);var e=t.prototype;return e._bindMapEvents=function(){var t=this,e=this.getMap();this.on("add",function(){t._updateGrids(),e.on("zoomstart zooming zoomend movestart moving moveend pitch rotate",t._updateGrids,t)}),this.on("remove",function(){e.off("zoomstart zooming zoomend movestart moving moveend pitch rotate",t._updateGrids,t)})},e._updateGrids=function(){var e=this.getMap();this._grids.forEach(function(t){t.indexs.length&&t.updateBBoxPixel(e)})},e.getSelectMesh=function(){var t=this.faceIndex;if(null!=t){if(!this._baseObjects[t]){var e=this._data[t],r=e.coordinate,n=e.height,i=e.color;this._baseObjects[t]=new ct(r,{height:n,index:t,color:i},this.getObject3d().material,this.getLayer()),this._proxyEvent(this._baseObjects[t])}return{data:this._data[t],baseObject:this._baseObjects[t]}}},e.identify=function(t){var e=this.getLayer(),r=this.getMap().getSize(),n=this.getLayer().getCamera(),i=this.getOptions().altitude,o=this.getMap(),a=e.distanceToVector3(i,i).x,s=this.getObject3d().material.size,h=o.coordToContainerPoint(t),c=[];if(this._grids.forEach(function(t){t.indexs.length&&t.isRecCross(h,s)&&c.push(t)}),c.length<1)return!1;for(var u=0,l=c.length;u<l;u++)for(var d=0,f=c[u].positions.length;d<f;d++){var v=c[u].positions[d];pt.x=v.x,pt.y=v.y,pt.z=v.z+a;var p=at(pt,r,n);if(Math.sqrt(Math.pow(h.x-p.x,2)+Math.pow(h.y-p.y,2))<=s/2)return this.faceIndex=c[u].indexs[d],!0}return!1},t}(r(u)),mt={coordinate:null,radius:10,height:100,radialSegments:6,altitude:0,topColor:null,bottomColor:"#2d2f61"},yt=function(L){function t(t,e,r,n){var i;F.BufferGeometryUtils||console.error("not find BufferGeometryUtils,please include related scripts"),Array.isArray(t)||(t=[t]);for(var o=t.length,a=[],s=[],h=[],c=[],u=0,l=0,d=0,f=0,v=0;v<o;v++){var p=R.Util.extend({index:v},mt,t[v]),g=p.radius,m=p.radialSegments,y=p.altitude,x=p.topColor,b=p.bottomColor,_=p.height,w=p.coordinate,M=n.distanceToVector3(g,g).x,C=n.distanceToVector3(_,_).x,O=n.distanceToVector3(y,y).x,j=k({radius:M,height:C,radialSegments:m},!1);x&&!r.map&&(W(j,b,x,"z",C/2),r.vertexColors=F.VertexColors);for(var A=n.coordinateToVector3(w),T=j.attributes.position.array,S=0,V=T.length;S<V;S+=3)T[S+2]+=O,T[S]+=A.x,T[S+1]+=A.y,T[S+2]+=A.z;a.push(j);var B=new q(w,p,r,n);s.push(B);var G=new F.Geometry;G.fromBufferGeometry(j);var I=G.faces.length;c[v]=[u+1,u+I],u+=I,G.dispose();var z=j.attributes.position.count,U=j.attributes.normal.count,E=j.attributes.uv.count;h[v]={position:{count:z,start:l,end:l+3*z},normal:{count:U,start:d,end:d+3*U},uv:{count:E,start:f,end:f+2*E},hide:!1},l+=3*z,d+=3*U,f+=2*E}i=L.call(this)||this,e=R.Util.extend({},{altitude:0,layer:n,points:t},e),i._initOptions(e);var P=F.BufferGeometryUtils.mergeBufferGeometries(a);return i._createMesh(P,r),i._faceMap=c,i._baseObjects=s,i._datas=t,i._geometriesAttributes=h,i.faceIndex=null,i._geometryCache=P.clone(),i.isHide=!1,i._initBaseObjectsEvent(s),i}n(t,L);var e=t.prototype;return e.getSelectMesh=function(){var t=this._getIndex();if(null!=t)return{data:this._datas[t],baseObject:this._baseObjects[t]}},e._getIndex=function(t){if(null==t&&(t=this.faceIndex),null!=t)for(var e=0,r=this._faceMap.length;e<r;e++){var n=this._faceMap[e],i=n[0],o=n[1];if(i<=t&&t<o)return e}},t}(r(u)),xt={width:3,height:1,altitude:0},bt=function(G){function t(t,e,r,n){var i;F.BufferGeometryUtils||console.error("not find BufferGeometryUtils,please include related scripts"),Array.isArray(t)||(t=[t]);for(var o=[],a=t.length,s=0;s<a;s++){var h=t[s];o.push(h.getCenter())}for(var c=J(o),u=[],l=[],d=0,f=[],v=[],p=0,g=0,m=0;m<a;m++){var y=t[m],x=R.Util.extend({},xt,y.getProperties(),{index:m}),b=x.height,_=x.width,w=P(y,n.distanceToVector3(_,_).x,n.distanceToVector3(b,b).x,n,c);u.push(w);var M=new Z(y,x,r,n);l.push(M);var C=new F.Geometry;C.fromBufferGeometry(w);var O=C.faces.length;f[m]=[d+1,d+O],d+=O,C.dispose();var j=w.attributes.position.count,A=w.attributes.normal.count;v[m]={position:{count:j,start:p,end:p+3*j},normal:{count:A,start:g,end:g+3*A},hide:!1},p+=3*j,g+=3*A}var T=F.BufferGeometryUtils.mergeBufferGeometries(u);e=R.Util.extend({},xt,e,{layer:n,lineStrings:t,coordinate:c}),(i=G.call(this)||this)._initOptions(e),i._createMesh(T,r);var S=e.altitude,V=n.distanceToVector3(S,S).x,B=n.coordinateToVector3(c,V);return i.getObject3d().position.copy(B),i._faceMap=f,i._baseObjects=l,i._datas=t,i._geometriesAttributes=v,i.faceIndex=null,i._geometryCache=T.clone(),i.isHide=!1,i._initBaseObjectsEvent(l),i}n(t,G);var e=t.prototype;return e.getSelectMesh=function(){var t=this._getIndex();if(null!=t)return{data:this._datas[t],baseObject:this._baseObjects[t]}},e._getIndex=function(t){if(null==t&&(t=this.faceIndex),null!=t)for(var e=0,r=this._faceMap.length;e<r;e++){var n=this._faceMap[e],i=n[0],o=n[1];if(i<=t&&t<o)return e}},t}(r(u)),_t={altitude:0,colors:null},wt=function(V){function t(t,e,r,n){var i;Array.isArray(t)||(t=[t]);for(var o=[],a=t.length,s=0;s<a;s++){var h=t[s];o.push(h.getCenter())}var c=J(o);e=R.Util.extend({},_t,e,{layer:n,lineStrings:t,coordinate:c});for(var u=[],l=0,d=[],f=[],v=0,p=[],g=0;g<a;g++){for(var m=t[g],y=R.Util.extend({},{altitude:e.altitude,index:g},m.getProperties()),x=B(m,n,c).positionsV,b=0,_=x.length;b<_;b++){var w=x[b];0<b&&b<_-1&&p.push(w.x,w.y,w.z),p.push(w.x,w.y,w.z)}var M=new D(m,y,r,n);u.push(M);var C=x.length+x.length-2,O=C;d[g]=[l,l+O],l+=O,f[g]={position:{count:C,start:v,end:v+3*C},hide:!1},v+=3*C}var j=new F.BufferGeometry;j.addAttribute("position",new F.Float32BufferAttribute(p,3)),(i=V.call(this)||this)._initOptions(e),i._createLineSegments(j,r);var A=e.altitude,T=n.distanceToVector3(A,A).x,S=n.coordinateToVector3(c,T);return i.getObject3d().position.copy(S),i._faceMap=d,i._baseObjects=u,i._datas=t,i._geometriesAttributes=f,i.faceIndex=null,i.index=null,i._geometryCache=j.clone(),i.isHide=!1,i._initBaseObjectsEvent(u),i}n(t,V);var e=t.prototype;return e.getSelectMesh=function(){var t=this._getIndex();if(null!=t)return{data:this._datas[t],baseObject:this._baseObjects[t]}},e._getIndex=function(t){if(null==t&&(t=this.faceIndex||this.index),null!=t)for(var e=0,r=this._faceMap.length;e<r;e++){var n=this._faceMap[e],i=n[0],o=n[1];if(i<=t&&t<o)return e}},t}(r(u)),Mt=Math.PI/180,Ct=[[4e3,220],[2e3,100],[1e3,30],[500,15],[100,5],[50,2],[10,1],[5,.7],[2,.1],[1,.05],[.5,.02]],Ot=["mousemove","click","mousedown","mouseup","dblclick","contextmenu","touchstart","touchmove","touchend"],jt=new F.Matrix4,At=function(t){function e(){return t.apply(this,arguments)||this}n(e,t);var r=e.prototype;return r.draw=function(){this.renderScene()},r.drawOnInteracting=function(){this.renderScene()},r.coordinateToVector3=function(t,e){void 0===e&&(e=0);var r=this.getMap();if(!r)return null;t instanceof R.Coordinate||(t=new R.Coordinate(t));var n=r.coordinateToPoint(t,St(r));return new F.Vector3(n.x,n.y,e)},r.distanceToVector3=function(t,e,r){var n=this.getMap(),i=St(n),o=r||n.getCenter();o instanceof R.Coordinate||(o=new R.Coordinate(o));var a=n.locate(o,t,e),s=n.coordinateToPoint(o,i),h=n.coordinateToPoint(a,i),c=Math.abs(h.x-s.x)*R.Util.sign(t),u=Math.abs(h.y-s.y)*R.Util.sign(e);return new F.Vector3(c,u,0)},r.toShape=function(t){var r=this;if(!t)return null;if(t instanceof R.MultiPolygon)return t.getGeometries().map(function(t){return r.toShape(t)});var e=t.getCenter(),n=this.coordinateToVector3(e),i=t.getShell().map(function(t){return r.coordinateToVector3(t).sub(n)}),o=new F.Shape(i),a=t.getHoles();return a&&0<a.length&&(o.holes=a.map(function(t){var e=t.map(function(t){return r.coordinateToVector3(t).sub(n)});return new F.Shape(e)})),o},r.toExtrudeMesh=function(t,e,r,n){var i=this;if(!t)return null;if(t instanceof R.MultiPolygon)return t.getGeometries().map(function(t){return i.toExtrudeMesh(t,e,r,n)});var o=t.getCoordinates();o.forEach(function(t){for(var e=t.length-1;1<=e;e--)t[e].equals(t[e-1])&&t.splice(e,1)}),t.setCoordinates(o);var a=this.toShape(t),s=this.coordinateToVector3(t.getCenter());n=R.Util.isNumber(n)?n:e,n=this.distanceToVector3(n,n).x;var h=this.distanceToVector3(e,e).x,c={bevelEnabled:!1,bevelSize:1};c[93<=parseInt(F.REVISION)?"depth":"amount"]=n;var u=new F.ExtrudeGeometry(a,c),l=new F.BufferGeometry;l.fromGeometry(u);var d=new F.Mesh(l,r);return d.position.set(s.x,s.y,h-n),d},r.toExtrudePolygon=function(t,e,r){return new K(t,e,r,this)},r.toBar=function(t,e,r){return new q(t,e,r,this)},r.toLine=function(t,e,r){return new D(t,e,r,this)},r.toExtrudeLine=function(t,e,r){return new Z(t,e,r,this)},r.toModel=function(t,e){return new s(t,e,this)},r.toExtrudeLineTrail=function(t,e,r){return new rt(t,e,r,this)},r.toExtrudePolygons=function(t,e,r){return new ot(t,e,r,this)},r.toPoint=function(t,e,r){return new ct(t,e,r,this)},r.toPoints=function(t,e,r){return new gt(t,e,r,this)},r.toBars=function(t,e,r){return new yt(t,e,r,this)},r.toExtrudeLines=function(t,e,r){return new bt(t,e,r,this)},r.toLines=function(t,e,r){return new wt(t,e,r,this)},r.clearMesh=function(){var t=this.getScene();if(!t)return this;for(var e=t.children.length-1;0<=e;e--)t.children[e]instanceof F.Mesh&&t.remove(t.children[e]);return this},r.lookAt=function(t){var e=this._getRenderer();return e&&e.context.lookAt(t),this},r.getCamera=function(){var t=this._getRenderer();return t?t.camera:null},r.getScene=function(){var t=this._getRenderer();return t?t.scene:null},r.renderScene=function(){var t=this._getRenderer();return t?t.renderScene():this},r.getThreeRenderer=function(){var t=this._getRenderer();return t?t.context:null},r.addMesh=function(t){var e=this;if(!t)return this;Array.isArray(t)||(t=[t]);var r=this.getScene();return t.forEach(function(t){t instanceof u?(r.add(t.getObject3d()),t.isAdd||(t.isAdd=!0,t._fire("add",{target:t})),t._animation&&R.Util.isFunction(t._animation)&&(e._animationBaseObjectMap[t.getObject3d().uuid]=t)):t instanceof F.Object3D&&r.add(t)}),this._zoomend(),this.renderScene(),this},r.removeMesh=function(t){var e=this;if(!t)return this;Array.isArray(t)||(t=[t]);var r=this.getScene();return t.forEach(function(t){t instanceof u?(r.remove(t.getObject3d()),t.isAdd&&(t.isAdd=!1,t._fire("remove",{target:t})),t._animation&&R.Util.isFunction(t._animation)&&delete e._animationBaseObjectMap[t.getObject3d().uuid]):t instanceof F.Object3D&&r.remove(t)}),this.renderScene(),this},r._initRaycaster=function(){return this._raycaster||(this._raycaster=new F.Raycaster,this._mouse=new F.Vector2),this},r.identify=function(e,t){var n=this;if(!e)return console.error("coordinate is null,it should be Coordinate"),[];if(Array.isArray(e)&&(e=new R.Coordinate(e)),!(e instanceof R.Coordinate))return console.error("coordinate type is error,it should be Coordinate"),[];var r=this.getMap().coordToContainerPoint(e),i=r.x,o=r.y;this._initRaycaster();var a=this._raycaster,s=this._mouse,h=this.getCamera(),c=this.getScene(),u=this.getMap().getSize();if(!c)return[];var l=u.width,d=u.height;s.x=i/l*2-1,s.y=-o/d*2+1,a.setFromCamera(s,h),a.linePrecision=this._getLinePrecision(this.getMap().getResolution());var f=[],v=[];c.children.forEach(function(t){var e=t.__parent;e&&e.getOptions?e.getOptions().interactive&&e.isVisible()&&(e.identify&&R.Util.isFunction(e.identify)?v.push(e):f.push(t)):(t instanceof F.Mesh||t instanceof F.Group)&&f.push(t)});var p=[],g=a.intersectObjects(f,!0);g&&Array.isArray(g)&&g.length&&(p=g.map(function(t){var e=t.object,r=(e=n._recursionMesh(e)).__parent||e;return r.faceIndex=t.faceIndex,r.index=t.index,r})),v.length&&v.forEach(function(t){t.identify(e)&&p.push(t)});var m=(t=R.Util.extend({},t)).count;return R.Util.isNumber(m)&&0<m?p.slice(0,m):p},r._recursionMesh=function(t){for(;t&&!(t.parent instanceof F.Scene);)t=t.parent;return t||{}},r._getLinePrecision=function(t){void 0===t&&(t=10);for(var e=0,r=Ct.length;e<r;e++){var n=Ct[e],i=n[0],o=n[1];if(i<t)return o}return.01},r._identifyBaseObjectEvents=function(r){var t=this.map||this.getMap();t.resetCursor("default");var n=r.type,i=r.coordinate,o=this.identify(i),e=this.getScene();if(0===o.length&&e)for(var a=0,s=e.children.length;a<s;a++){var h=(e.children[a]||{}).__parent;h&&h._fire("empty",Object.assign({},r,{target:h}))}if("mousemove"===n){o.length&&t.setCursor("pointer");var c=[];this._baseObjects&&this._baseObjects.forEach(function(e){var r=!0;o.forEach(function(t){e===t&&(r=!1)}),r&&c.push(e)}),c.forEach(function(t){t instanceof u&&(t.getSelectMesh?t.isHide||(t._mouseover=!1,t._fire("mouseout",Object.assign({},r,{target:t,type:"mouseout",selectMesh:null})),t.closeToolTip()):(t._mouseover=!1,t._fire("mouseout",Object.assign({},r,{target:t,type:"mouseout"})),t.closeToolTip()))}),o.forEach(function(t){if(t instanceof u){t._mouseover||(t._fire("mouseover",Object.assign({},r,{target:t,type:"mouseover",selectMesh:t.getSelectMesh?t.getSelectMesh():null})),t._mouseover=!0),t._fire(n,Object.assign({},r,{target:t,selectMesh:t.getSelectMesh?t.getSelectMesh():null}));var e=t.getToolTip();e&&!e._owner&&e.addTo(t),t.openToolTip(i)}})}else o.forEach(function(t){if(t instanceof u&&(t._fire(n,Object.assign({},r,{target:t,selectMesh:t.getSelectMesh?t.getSelectMesh():null})),"click"===n)){var e=t.getInfoWindow();e&&!e._owner&&e.addTo(t),t.openInfoWindow(i)}});return this._baseObjects=o,this},r._zoomend=function(){var t=this.getScene();if(t){var i=this.getMap().getZoom();t.children.forEach(function(t){var e=t.__parent;if(e&&e.getOptions){var r=e.getMinZoom(),n=e.getMaxZoom();(i<r||n<i)&&e.isVisible()?e.hide():r<=i&&i<=n&&!e.isVisible()&&e.show()}})}},r.onAdd=function(){var e=this;t.prototype.onAdd.call(this);var r=this.map||this.getMap();return r&&(Ot.forEach(function(t){r.on(t,e._identifyBaseObjectEvents,e)}),this._needsUpdate=!0,this._animationBaseObjectMap||(this._animationBaseObjectMap={}),r.on("zooming zoomend",this._zoomend,this)),this},r.onRemove=function(){var e=this;t.prototype.onRemove.call(this);var r=this.map||this.getMap();return r&&(Ot.forEach(function(t){r.off(t,e._identifyBaseObjectEvents,e)}),r.off("zooming zoomend",this._zoomend,this)),this},r._callbackBaseObjectAnimation=function(){if(this._animationBaseObjectMap)for(var t in this._animationBaseObjectMap){this._animationBaseObjectMap[t]._animation()}return this},r._getFovRatio=function(){var t=this.getMap().getFov();return Math.tan(t/2*Mt)},e}(R.CanvasLayer);At.mergeOptions({renderer:"gl",doubleBuffer:!1,glOptions:null});var Tt=function(t){function e(){return t.apply(this,arguments)||this}n(e,t);var r=e.prototype;return r.getPrepareParams=function(){return[this.scene,this.camera]},r.getDrawParams=function(){return[this.scene,this.camera]},r._drawLayer=function(){t.prototype._drawLayer.apply(this,arguments),this.renderScene()},r.hitDetect=function(){return!1},r.createCanvas=function(){t.prototype.createCanvas.call(this),this.createContext()},r.createContext=function(){if(this.canvas.gl&&this.canvas.gl.wrap)this.gl=this.canvas.gl.wrap();else{var t=this.layer.options.glOptions||{alpha:!0,depth:!0,antialias:!0,stencil:!0};t.preserveDrawingBuffer=!0,this.gl=this.gl||this._createGLContext(this.canvas,t)}this._initThreeRenderer(),this.layer.onCanvasCreate(this.context,this.scene,this.camera)},r._initThreeRenderer=function(){var t=new F.WebGLRenderer({context:this.gl,alpha:!0});t.autoClear=!1,t.setClearColor(new F.Color(1,1,1),0),t.setSize(this.canvas.width,this.canvas.height),t.clear(),t.canvas=this.canvas,this.context=t;var e=this.scene=new F.Scene,r=this.layer.getMap(),n=r.getFov()*Math.PI/180,i=this.camera=new F.PerspectiveCamera(n,r.width/r.height,r.cameraNear,r.cameraFar);i.matrixAutoUpdate=!1,this._syncCamera(),e.add(i)},r.onCanvasCreate=function(){t.prototype.onCanvasCreate.call(this)},r.resizeCanvas=function(t){if(this.canvas){var e;e=t||this.getMap().getSize();var r=R.Browser.retina?2:1,n=this.canvas;n.height=r*e.height,n.width=r*e.width,this.context.setSize(n.width,n.height)}},r.clearCanvas=function(){this.canvas&&this.context.clear()},r.prepareCanvas=function(){return this.canvas?this.clearCanvas():this.createCanvas(),this.layer.fire("renderstart",{context:this.context}),null},r.renderScene=function(){this.layer._callbackBaseObjectAnimation(),this._syncCamera(),this.context.render(this.scene,this.camera),this.completeRender()},r.remove=function(){delete this._drawContext,t.prototype.remove.call(this)},r._syncCamera=function(){var t=this.getMap(),e=this.camera;e.matrix.elements=t.cameraWorldMatrix,e.projectionMatrix.elements=t.projMatrix,e.projectionMatrixInverse.elements=jt.getInverse(e.projectionMatrix).elements},r._createGLContext=function(t,e){for(var r=["webgl","experimental-webgl"],n=null,i=0;i<r.length;++i){try{n=t.getContext(r[i],e)}catch(t){}if(n)break}return n},e}(R.renderer.CanvasLayerRenderer);function St(t){return t.getGLZoom()}At.registerRenderer("gl",Tt),t.ThreeLayer=At,t.ThreeRenderer=Tt,t.BaseObject=u,Object.defineProperty(t,"__esModule",{value:!0}),"undefined"!=typeof console&&console.log("maptalks.three v0.7.3, requires maptalks@>=0.39.0.")});
